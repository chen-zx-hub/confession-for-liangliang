<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D æ‰‹åŠ¿äº¤äº’ç²’å­ç³»ç»Ÿ</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
        }
        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        #ui-container {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 280px;
            background: rgba(20, 20, 30, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 10;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            transition: transform 0.3s ease;
        }
        .control-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #aaa;
        }
        select, input[type="color"] {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #222;
            color: white;
            outline: none;
        }
        button {
            width: 100%;
            padding: 10px;
            background: linear-gradient(45deg, #ff00cc, #3333ff);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:hover {
            opacity: 0.9;
        }
        #video-preview {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 160px;
            height: 120px;
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            z-index: 10;
            object-fit: cover;
            transform: scaleX(-1); /* é•œåƒç¿»è½¬ */
            background: #000;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: white;
            z-index: 20;
            pointer-events: none;
            text-align: center;
        }
        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #ff3333;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-active {
            background-color: #33ff33;
        }
        #gesture-info {
            margin-top: 10px;
            font-size: 12px;
            color: #888;
            text-align: center;
        }

        #heart-date {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            color: #fff8e7; /* æš–ç±³è‰² */
            text-shadow: 0 0 15px #ff8c00, 0 0 30px #ff4500; /* æš–æ©™è‰²å…‰æ™• */
            z-index: 4;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
            font-family: 'Segoe UI', cursive;
            letter-spacing: 5px;
            font-weight: bold;
        }

        #fireworks-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8rem;
            color: #ff00ff; /* éœ“è™¹ç²‰ */
            text-shadow: 0 0 20px #ff00ff, 0 0 40px #00ffff;
            z-index: 4;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
            font-family: 'Segoe UI', sans-serif;
            font-weight: 900;
        }
    </style>
</head>
<body>

    <div id="loading">æ­£åœ¨åŠ è½½æ¨¡å‹ä¸æ‘„åƒå¤´...<br><span style="font-size:14px; opacity:0.7">è¯·å…è®¸æ‘„åƒå¤´æƒé™</span></div>
    
    <div id="heart-date">2024.10.1</div>
    <div id="fireworks-text">520</div>
    <div id="canvas-container"></div>
    
    <video id="video-preview" playsinline></video>

    <div id="ui-container">
        <h3 style="margin-top:0; text-align:center;">ğŸ„ åœ£è¯èŠ‚å’¯</h3>
        
        <div class="control-group">
            <label>é€‰æ‹©æ¨¡å‹</label>
            <select id="shape-select">
                <option value="heart">â¤ï¸ é™ˆå°æ˜•</option>
                <option value="tree">ğŸ„ åœ£è¯æ ‘ (Christmas Tree)</option>
                <option value="fireworks">ğŸ† çƒŸèŠ± (Fireworks)</option>
            </select>
        </div>

        <div class="control-group">
            <label>ç²’å­é¢œè‰²</label>
            <input type="color" id="color-picker" value="#ff00cc">
        </div>

        <div class="control-group">
            <label>çŠ¶æ€: <span id="status-text">ç­‰å¾…æ‘„åƒå¤´...</span> <span id="status-dot" class="status-dot"></span></label>
            <div id="gesture-info">å¼ å¼€/æåˆæ‰‹æŒ‡æ§åˆ¶ç¼©æ”¾</div>
        </div>

        <button id="fullscreen-btn">å…¨å±æ¨¡å¼</button>
    </div>

    <!-- å¼•å…¥åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

    <script>
        // --- å…¨å±€å˜é‡ ---
        let scene, camera, renderer, particles, geometry, material;
        let targetPositions = [];
        let targetColors = [];
        let currentPositions = [];
        const particleCount = 15000;
        let currentShape = 'heart';
        let handScale = 1.0; // æ‰‹åŠ¿æ§åˆ¶çš„ç¼©æ”¾å› å­
        let baseColor = new THREE.Color(0xff00cc);
        let time = 0;

        // --- åˆå§‹åŒ– Three.js ---
        function initThree() {
            const container = document.getElementById('canvas-container');
            
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.002);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 30;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            // åˆ›å»ºç²’å­ç³»ç»Ÿ
            geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(particleCount * 3);
            const colors = new Float32Array(particleCount * 3);
            
            // åˆå§‹éšæœºä½ç½®
            for (let i = 0; i < particleCount * 3; i++) {
                positions[i] = (Math.random() - 0.5) * 100;
                colors[i] = 1.0;
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            // åˆ›å»ºæè´¨
            const sprite = new THREE.TextureLoader().load('https://threejs.org/examples/textures/sprites/disc.png');
            material = new THREE.PointsMaterial({
                size: 0.4,
                vertexColors: true,
                map: sprite,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);

            // åˆå§‹åŒ–ç›®æ ‡ä½ç½®
            generateShape('heart');

            // ç›‘å¬çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', onWindowResize, false);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- å½¢çŠ¶ç”Ÿæˆé€»è¾‘ ---
        function generateShape(type) {
            currentShape = type;
            targetPositions = [];
            targetColors = [];
            
            // è·å–å½“å‰é€‰æ‹©å™¨é¢œè‰²ä½œä¸ºé»˜è®¤é¢œè‰²
            const hexColor = document.getElementById('color-picker').value;
            const defaultColor = new THREE.Color(hexColor);

            for (let i = 0; i < particleCount; i++) {
                let x, y, z;
                let r = defaultColor.r, g = defaultColor.g, b = defaultColor.b;

                if (type === 'heart') {
                    // æ›´ç²¾è‡´çš„ 3D çˆ±å¿ƒ (åŸºäºéšå¼æ–¹ç¨‹çš„ä½“ç§¯å¡«å……)
                    // (x^2 + 9/4y^2 + z^2 - 1)^3 - x^2z^3 - 9/80y^2z^3 <= 0
                    // æˆ‘ä»¬ä½¿ç”¨æ‹’ç»é‡‡æ ·æ³•æ¥å¡«å……è¿™ä¸ªä½“ç§¯
                    
                    let valid = false;
                    let count = 0;
                    while (!valid && count < 100) {
                        // éšæœºé‡‡æ ·èŒƒå›´ [-1.5, 1.5]
                        let u = (Math.random() - 0.5) * 3;
                        let v = (Math.random() - 0.5) * 3;
                        let w = (Math.random() - 0.5) * 3;

                        // æ ¸å¿ƒæ–¹ç¨‹ (zè½´å‘ä¸Š)
                        // x = u, y = v, z = w
                        // å…¬å¼ä¸­ z æ˜¯å‚ç›´è½´ï¼Œy æ˜¯å‰åè½´(è¾ƒæ‰)
                        
                        let xx = u;
                        let yy = v; 
                        let zz = w;

                        // è®¡ç®—æ–¹ç¨‹å€¼
                        let a = xx*xx + 2.25*yy*yy + zz*zz - 1;
                        let val = a*a*a - (xx*xx*zz*zz*zz) - (0.1125*yy*yy*zz*zz*zz);
                        
                        if (val <= 0) {
                            valid = true;
                            
                            // ç¼©æ”¾å¹¶æ˜ å°„åˆ° Three.js åæ ‡ç³» (yå‘ä¸Š)
                            const scale = 10;
                            x = u * scale;
                            y = w * scale; // å…¬å¼z -> Three.js y
                            z = v * scale; // å…¬å¼y -> Three.js z

                            // é¢œè‰²ä¼˜åŒ–ï¼šæ·¡ç²‰è‰²è°ƒ (Pale Pink)
                            // æ ¸å¿ƒï¼šç™½ç²‰ -> è¾¹ç¼˜ï¼šæŸ”å’Œç²‰
                            const dist = Math.sqrt(x*x + y*y + z*z);
                            const normalizedDist = dist / 12;
                            
                            // æ·¡ç²‰è‰²æ¸å˜
                            r = 1.0; 
                            // ç»¿è‰²é€šé“ï¼šä¸­å¿ƒé«˜(ç™½)ï¼Œè¾¹ç¼˜ä½(ç²‰çº¢)
                            g = Math.max(0.4, 0.9 - normalizedDist * 0.6); 
                            // è“è‰²é€šé“ï¼šä¿æŒè¾ƒé«˜ï¼Œè¥é€ ç²‰å«©æ„Ÿ
                            b = Math.max(0.6, 0.95 - normalizedDist * 0.5); 
                            
                            // å¢åŠ ä¸€äº›çº¯ç™½é—ªçƒç²’å­
                            if (Math.random() > 0.96) {
                                r = 1; g = 1; b = 1; 
                            }
                        }
                        count++;
                    }
                    // å¦‚æœå°è¯•å¤šæ¬¡æœªæ‰¾åˆ°ç‚¹ï¼ˆæå°‘æƒ…å†µï¼‰ï¼Œå›é€€åˆ°åŸç‚¹é™„è¿‘
                    if (!valid) {
                        x = (Math.random()-0.5);
                        y = (Math.random()-0.5);
                        z = (Math.random()-0.5);
                    }
                } 
                else if (type === 'tree') {
                    // ä¼˜åŒ–åçš„åœ£è¯æ ‘
                    // æ ‘å¹²
                    if (i < particleCount * 0.05) {
                        x = (Math.random() - 0.5) * 1.5;
                        z = (Math.random() - 0.5) * 1.5;
                        y = (Math.random() * 4) - 12; 
                        // æ£•è‰²
                        r = 0.55; g = 0.27; b = 0.07;
                    } else {
                        // æ ‘å† 
                        const h = Math.random(); // 0-1
                        // èºæ—‹åˆ†å¸ƒ
                        const angle = h * Math.PI * 15 + Math.random() * Math.PI * 2;
                        const maxR = 11 * (1 - h) + 0.5;
                        const rad = Math.sqrt(Math.random()) * maxR;
                        
                        x = rad * Math.cos(angle);
                        z = rad * Math.sin(angle);
                        y = -8 + h * 22;

                        // ç»¿è‰²æ¸å˜
                        r = 0.0; g = 0.4 + Math.random() * 0.6; b = 0.1;

                        // è£…é¥°å“ (15% æ¦‚ç‡ï¼Œä¸”åœ¨è¡¨é¢)
                        if (Math.random() < 0.15 && rad > maxR * 0.7) {
                            const ornament = Math.random();
                            if (ornament < 0.3) { r=1; g=0.1; b=0.1; } // çº¢
                            else if (ornament < 0.6) { r=1; g=0.84; b=0; } // é‡‘
                            else { r=0.2; g=0.6; b=1; } // è“
                            
                            x *= 1.05;
                            z *= 1.05;
                        }
                        
                        // æ ‘é¡¶æ˜Ÿæ˜Ÿ
                        if (h > 0.98) {
                            r = 1; g = 1; b = 0.2;
                            x = (Math.random()-0.5) * 1.5;
                            z = (Math.random()-0.5) * 1.5;
                            y = 14 + Math.random() * 2;
                        }
                    }
                }
                else if (type === 'fireworks') {
                    const rad = 20 * Math.cbrt(Math.random());
                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.acos(2 * Math.random() - 1);
                    
                    x = rad * Math.sin(phi) * Math.cos(theta);
                    y = rad * Math.sin(phi) * Math.sin(theta);
                    z = rad * Math.cos(phi);
                    
                    // çƒŸèŠ±éšæœºè‰²
                    r = Math.random();
                    g = Math.random();
                    b = Math.random();
                }

                targetPositions.push({x, y, z});
                targetColors.push({r, g, b});
            }
        }

        // --- åŠ¨ç”»å¾ªç¯ ---
        function animate() {
            requestAnimationFrame(animate);

            time += 0.01;
            
            // ç²’å­åŠ¨ç”»é€»è¾‘
            const positions = particles.geometry.attributes.position.array;
            const colors = particles.geometry.attributes.color.array;
            
            // æ—‹è½¬æ•´ä¸ªç²’å­ç³»ç»Ÿ
            particles.rotation.y += 0.002;

            for (let i = 0; i < particleCount; i++) {
                const target = targetPositions[i];
                const targetCol = targetColors[i];
                const idx = i * 3;

                // åŸºç¡€ç›®æ ‡ä½ç½®
                let tx = target.x;
                let ty = target.y;
                let tz = target.z;

                // åº”ç”¨æ‰‹åŠ¿ç¼©æ”¾ (handScale)
                const scale = Math.max(0.1, Math.min(3.0, handScale));
                
                tx *= scale;
                ty *= scale;
                tz *= scale;

                // å¢åŠ ä¸€äº›åŠ¨æ€å™ªç‚¹/å‘¼å¸æ•ˆæœ
                if (currentShape === 'fireworks') {
                    tx += Math.sin(time + i) * 0.5;
                    ty += Math.cos(time + i) * 0.5;
                } else {
                    tx += Math.sin(time * 2 + i) * 0.1;
                    ty += Math.cos(time * 3 + i) * 0.1;
                }

                // çº¿æ€§æ’å€¼ (Lerp) å¹³æ»‘ç§»åŠ¨
                positions[idx] += (tx - positions[idx]) * 0.1;
                positions[idx + 1] += (ty - positions[idx + 1]) * 0.1;
                positions[idx + 2] += (tz - positions[idx + 2]) * 0.1;

                // é¢œè‰²æ’å€¼
                if (targetCol) {
                    colors[idx] += (targetCol.r - colors[idx]) * 0.1;
                    colors[idx + 1] += (targetCol.g - colors[idx + 1]) * 0.1;
                    colors[idx + 2] += (targetCol.b - colors[idx + 2]) * 0.1;
                }
            }

            particles.geometry.attributes.position.needsUpdate = true;
            particles.geometry.attributes.color.needsUpdate = true;
            renderer.render(scene, camera);

            // æ›´æ–°æ—¥æœŸæ˜¾ç¤ºé€»è¾‘
            const dateEl = document.getElementById('heart-date');
            if (currentShape === 'heart') {
                // å½“æ‰‹åŠ¿å¼ å¼€ (scale > 1.2) æ—¶æ˜¾ç¤ºï¼Œå¹³æ»‘è¿‡æ¸¡
                let opacity = 0;
                if (handScale > 1.2) {
                    opacity = Math.min(1, (handScale - 1.2) / 0.5);
                }
                dateEl.style.opacity = opacity;
                // éšæ‰‹åŠ¿è½»å¾®ç¼©æ”¾
                dateEl.style.transform = `translate(-50%, -50%) scale(${0.8 + opacity * 0.4})`;
            } else {
                dateEl.style.opacity = 0;
            }

            // æ›´æ–°çƒŸèŠ±æ–‡å­—æ˜¾ç¤ºé€»è¾‘
            const fireworksEl = document.getElementById('fireworks-text');
            if (currentShape === 'fireworks') {
                let opacity = 0;
                if (handScale > 1.2) {
                    opacity = Math.min(1, (handScale - 1.2) / 0.5);
                }
                fireworksEl.style.opacity = opacity;
                fireworksEl.style.transform = `translate(-50%, -50%) scale(${0.8 + opacity * 0.4})`;
            } else {
                fireworksEl.style.opacity = 0;
            }
        }

        // --- MediaPipe Hands é›†æˆ ---
        function onResults(results) {
            const loading = document.getElementById('loading');
            if (loading) loading.style.display = 'none';

            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                statusDot.classList.add('status-active');
                statusText.innerText = "å·²æ£€æµ‹åˆ°æ‰‹åŠ¿";
                
                // è·å–ç¬¬ä¸€åªæ‰‹
                const landmarks = results.multiHandLandmarks[0];
                
                // è®¡ç®—æ‹‡æŒ‡æŒ‡å°–(4)å’Œé£ŸæŒ‡æŒ‡å°–(8)çš„è·ç¦»
                const thumbTip = landmarks[4];
                const indexTip = landmarks[8];
                
                // è®¡ç®—æ¬§å‡ é‡Œå¾—è·ç¦» (åœ¨ 0-1 åæ ‡ç³»ä¸­)
                const distance = Math.sqrt(
                    Math.pow(thumbTip.x - indexTip.x, 2) + 
                    Math.pow(thumbTip.y - indexTip.y, 2)
                );

                // æ˜ å°„è·ç¦»åˆ°ç¼©æ”¾å› å­
                // é€šå¸¸æåˆæ—¶è·ç¦» < 0.05ï¼Œå¼ å¼€æ—¶ > 0.2
                // æˆ‘ä»¬å°†å…¶æ˜ å°„åˆ° 0.5 (å°) åˆ° 2.0 (å¤§)
                
                // å¹³æ»‘å¤„ç†
                const targetScale = mapRange(distance, 0.02, 0.25, 0.3, 2.5);
                handScale += (targetScale - handScale) * 0.1; // ç®€å•çš„å¹³æ»‘æ»¤æ³¢

            } else {
                statusDot.classList.remove('status-active');
                statusText.innerText = "æœªæ£€æµ‹åˆ°æ‰‹åŠ¿";
                // å¦‚æœæ²¡æœ‰æ‰‹ï¼Œç¼“æ…¢æ¢å¤åˆ°é»˜è®¤å¤§å°
                handScale += (1.0 - handScale) * 0.05;
            }
        }

        function mapRange(value, inMin, inMax, outMin, outMax) {
            return (value - inMin) * (outMax - outMin) / (inMax - inMin) + outMin;
        }

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            initThree();
            animate();

            // UI äº‹ä»¶ç›‘å¬
            document.getElementById('shape-select').addEventListener('change', (e) => {
                generateShape(e.target.value);
            });

            document.getElementById('color-picker').addEventListener('input', (e) => {
                material.color.set(e.target.value);
            });

            document.getElementById('fullscreen-btn').addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            });

            // å¯åŠ¨æ‘„åƒå¤´
            const videoElement = document.getElementById('video-preview');
            const hands = new Hands({locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            }});

            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            hands.onResults(onResults);

            const cameraUtils = new Camera(videoElement, {
                onFrame: async () => {
                    await hands.send({image: videoElement});
                },
                width: 320,
                height: 240
            });
            
            cameraUtils.start()
                .then(() => console.log("Camera started"))
                .catch(err => {
                    console.error("Camera error:", err);
                    document.getElementById('status-text').innerText = "æ‘„åƒå¤´å¯åŠ¨å¤±è´¥";
                });
        };

    </script>
</body>
</html>
